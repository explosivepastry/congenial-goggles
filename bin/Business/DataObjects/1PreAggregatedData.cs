// Decompiled with JetBrains decompiler
// Type: Monnit.Data.PreAggregatedData
// Assembly: Business, Version=2.5.0.6, Culture=neutral, PublicKeyToken=null
// MVID: ADEA1334-3F26-4050-9B0F-973EB7B9AD1C
// Assembly location: C:\inetpub\wwwroot\Enterprise\bin\Business.dll

using RedefineImpossible;
using System;
using System.Collections.Generic;
using System.Data;

#nullable disable
namespace Monnit.Data;

internal class PreAggregatedData
{
  [DBMethod("PreAggregatedData_LoadPageBySensorIDAndDateRange")]
  [DBMethodBody(DBMS.SqlServer, "\r\nDECLARE @PATemp TABLE(\r\n  [Date]                DATETIME,\r\n\t[SensorID]            BIGINT,\r\n\t[PASensorGUID]        UNIQUEIDENTIFIER,\r\n\t[AccountID]           BIGINT,\r\n\t[ApplicationName]     VARCHAR(100),\r\n\t[ApplicationID]\t\t  INT,\r\n\t[CSNetID]             BIGINT,\r\n\t[SplitValue]          VARCHAR(100),\r\n\t[Min]                 DECIMAL(16,4),\r\n\t[Max]                 DECIMAL(16,4),\r\n\t[Avg]                 DECIMAL(16,4),\r\n\t[FalseCount]          INT,\r\n\t[TrueCount]           INT,\r\n\t[Avg_Voltage]         DECIMAL(5,4),\r\n\t[SensorMessageCounts] INT,\r\n\t[AwareStateCounts]    INT,\r\n\t[CreateDate]          DATETIME,\r\n  [Avg_SignalStrength]  DECIMAL(8,2)\r\n);\r\n\r\n\r\nDECLARE @StartDate DATETIME;\r\nDECLARE @SQL VARCHAR(2000);\r\nDECLARE @TimeZoneIDString VARCHAR(200);\r\n\r\nSELECT\r\n  @StartDate = ISNULL(startdate, '2010-01-01'),\r\n  @TimeZoneIDString = t.TimeZoneIDString\r\nFROM dbo.[Sensor] s WITH (NOLOCK)\r\nINNER JOIN dbo.[Account] a WITH (NOLOCK)  on s.AccountID = a.AccountID\r\nINNER JOIN dbo.[TimeZone] t WITH (NOLOCK) on a.TimeZoneID = t.TimeZoneID\r\nWHERE SensorID = @SensorID;\r\n\r\n\r\nIF @StartDate < DATEADD(HOUR, -24, GETUTCDATE())\r\n  SET @StartDate = DATEADD(HOUR, -24, GETUTCDATE())\r\n\r\nSET @SQL = \r\n\r\n'SELECT\r\n  p.*\r\nFROM dbo.[PreAggregation] p WITH (NOLOCK)\r\nINNER JOIN dbo.[Sensor] s WITH (NOLOCK) ON p.SensorID = s.SensorID and p.AccountID = s.AccountID\r\nWHERE p.[SensorID] = '+CONVERT(VARCHAR(15), @SensorID)+'\r\n  AND Date >= '''+ CONVERT(VARCHAR(30), dbo.GetLocalTime(@FromDate, @TimeZoneIDSTring)) +'''\r\n  AND Date <= '''+ CONVERT(VARCHAR(30), dbo.GetLocalTime(@ToDate, @TimeZoneIDString)) +''' \r\n  AND Date >=  DATEADD(DAY, -1, CONVERT(DATETIME, CONVERT(VARCHAR(11), dbo.GetLocalTime(ISNULL(StartDate,  ''2010-01-01 00:00:00''),'''+ @TimeZOneIDString+'''), 120)))';\r\n\r\nINSERT INTO @PATemp\r\nEXEC (@SQL);\r\n\r\n\r\nSET @SQL = \r\n'SELECT TOP 4\r\n  d.*\r\nFROM dbo.[DataMessage] d WITH (NOLOCK)\r\nWHERE [MessageDate] BETWEEN '''+ CONVERT(VARCHAR(30), DATEADD(HOUR, -24, GETUTCDATE())) + ''' AND ''' + CONVERT(VARCHAR(30), GETUTCDATE()) + '''\r\n  AND [MessageDate] >= ''' + CONVERT(VARCHAR(30), @StartDate) + '''\r\n  AND [SensorID] = '+CONVERT(VARCHAR(15), @SensorID)+'\r\nORDER BY [MessageDate] DESC';\r\n\r\nEXEC (@SQL);\r\n\r\nSELECT * FROM @PATemp ORDER BY Date;\r\n")]
  internal class LoadPageBySensorIDAndDateRange : BaseDBMethod
  {
    [DBMethodParam("SensorID", typeof (long))]
    public long SensorID { get; private set; }

    [DBMethodParam("FromDate", typeof (DateTime))]
    public DateTime FromDate { get; private set; }

    [DBMethodParam("ToDate", typeof (DateTime))]
    public DateTime ToDate { get; private set; }

    public DataSet Result { get; private set; }

    public LoadPageBySensorIDAndDateRange(long sensorID, DateTime fromDate, DateTime toDate)
    {
      this.SensorID = sensorID;
      this.FromDate = fromDate;
      this.ToDate = toDate;
      this.Result = this.ToDataSet();
    }

    public static DataSet Exec(long sensorID, DateTime fromDate, DateTime toDate)
    {
      return new PreAggregatedData.LoadPageBySensorIDAndDateRange(sensorID, fromDate, toDate).Result;
    }
  }

  [DBMethod("PreAggregatedData_LoadBySensorIDAndDateRange")]
  [DBMethodBody(DBMS.SqlServer, "\r\nDECLARE @PATemp TABLE(\r\n  [Date]                DATETIME,\r\n\t[SensorID]            BIGINT,\r\n\t[PASensorGUID]        UNIQUEIDENTIFIER,\r\n\t[AccountID]           BIGINT,\r\n\t[ApplicationName]     VARCHAR(100),\r\n\t[ApplicationID]       INT,\r\n\t[CSNetID]             BIGINT,\r\n\t[SplitValue]          VARCHAR(100),\r\n\t[Min]                 DECIMAL(16,4),\r\n\t[Max]                 DECIMAL(16,4),\r\n\t[Avg]                 DECIMAL(16,4),\r\n\t[FalseCount]          INT,\r\n\t[TrueCount]           INT,\r\n\t[Avg_Voltage]         DECIMAL(5,4),\r\n\t[SensorMessageCounts] INT,\r\n\t[AwareStateCounts]    INT,\r\n\t[CreateDate]          DATETIME,\r\n  [Avg_SignalStrength]  DECIMAL(8,2)\r\n);\r\n\r\n\r\nDECLARE @StartDate DATETIME;\r\nDECLARE @SQL VARCHAR(2000);\r\nDECLARE @TimeZoneIDString VARCHAR(200);\r\n\r\nSELECT\r\n  @StartDate = ISNULL(startdate, '2010-01-01'),\r\n  @TimeZoneIDString = t.TimeZoneIDString\r\nFROM dbo.[Sensor] s WITH (NOLOCK)\r\nINNER JOIN dbo.[Account] a WITH (NOLOCK)  on s.AccountID = a.AccountID\r\nINNER JOIN dbo.[TimeZone] t WITH (NOLOCK) on a.TimeZoneID = t.TimeZoneID\r\nWHERE SensorID = @SensorID;\r\n\r\n\r\nSET @SQL = \r\n\r\n'SELECT\r\n  p.*\r\nFROM dbo.[PreAggregation] p WITH (NOLOCK)\r\nINNER JOIN dbo.[Sensor] s WITH (NOLOCK) ON p.SensorID = s.SensorID and p.AccountID = s.AccountID\r\nWHERE p.[SensorID] = '+CONVERT(VARCHAR(15), @SensorID)+'\r\n  AND Date >= '''+ CONVERT(VARCHAR(30), dbo.GetLocalTime(@FromDate, @TimeZoneIDSTring)) +'''\r\n  AND Date <= '''+ CONVERT(VARCHAR(30), dbo.GetLocalTime(@ToDate, @TimeZoneIDString)) +''' \r\n  AND Date >=  DATEADD(DAY, -1, CONVERT(DATETIME, CONVERT(VARCHAR(11), dbo.GetLocalTime(ISNULL(StartDate,  ''2010-01-01 00:00:00''),'''+ @TimeZOneIDString+'''), 120)))';\r\n\r\nINSERT INTO @PATemp\r\nEXEC (@SQL);\r\n\r\nSELECT * FROM @PATemp ORDER BY Date;")]
  internal class LoadBySensorIDAndDateRange : BaseDBMethod
  {
    [DBMethodParam("SensorID", typeof (long))]
    public long SensorID { get; private set; }

    [DBMethodParam("FromDate", typeof (DateTime))]
    public DateTime FromDate { get; private set; }

    [DBMethodParam("ToDate", typeof (DateTime))]
    public DateTime ToDate { get; private set; }

    public List<Monnit.PreAggregatedData> Result { get; private set; }

    public LoadBySensorIDAndDateRange(long sensorID, DateTime fromDate, DateTime toDate)
    {
      this.SensorID = sensorID;
      this.FromDate = fromDate;
      this.ToDate = toDate;
      this.Result = BaseDBObject.Load<Monnit.PreAggregatedData>(this.ToDataTable());
    }
  }

  [DBMethod("Message_PreAggChartByDate")]
  [DBMethodBody(DBMS.SqlServer, "\r\n\r\nDECLARE @FromDate DATETIME\r\nDECLARE @ToDate DATETIME\r\n\r\nSET @FromDate = @UTCStartDate\r\nSET @ToDate = DATEADD(HOUR, 24, @FromDate)\r\n\r\nDECLARE @AccountID BIGINT\r\nDECLARE @CSNetID BIGINT\r\nDECLARE @ApplicationID BIGINT\r\nDECLARE @SQL VARCHAR(5000)\r\ndeclare @errormessage varchar(3000)\r\n\r\n\r\nCREATE TABLE #tempresults\r\n( \r\n  [RowID] INT IDENTITY(1,1) PRIMARY KEY CLUSTERED,\r\n  [AccountID] BIGINT,\r\n  [SensorID] BIGINT NOT NULL,\r\n  [CSNetID] BIGINT,\r\n  [Year] BIGINT,\r\n  [Month] INT,\r\n  [Day] INT,\r\n  [data] VARCHAR(2000),\r\n  [Voltage] DECIMAL(5,4),\r\n  [State] INT,\r\n  [ApplicationID] INT,\r\n  [ApplicationName] VARCHAR(100),\r\n  [SignalStrength] INT,\r\n);\r\n\r\nCREATE TABLE #Holding\r\n(\r\n  [AccountID]           BIGINT, \r\n  [SensorID]            BIGINT, \r\n  [CSNetID]             BIGINT, \r\n  [Year]                INT,\r\n  [Month]               INT, \r\n  [Day]                 INT, \r\n  [data1]               DECIMAL(18,2), \r\n  [data2]               DECIMAL(18,2), \r\n  [Voltage]             DECIMAL(5,4), \r\n  [state]               INT, \r\n  [ApplicationID] INT,\r\n  [ApplicationName]     VARCHAR(255),\r\n  [SignalStrength]      INT\r\n);\r\n\r\nCREATE INDEX [IDX_Temp1] on #TempResults (ApplicationID, RowID);\r\n\r\nCREATE TABLE #PreAgg\r\n(\r\n  [AccountID]           BIGINT,\r\n  [SensorID]            BIGINT,\r\n  [ApplicationName]     VARCHAR(100),\r\n  [ApplicationID] BIGINT,\r\n  [CSNetID]             BIGINT,\r\n  [Year]                INT,\r\n  [Month]               INT,\r\n  [Day]                 INT,\r\n  [SplitValue]          VARCHAR(255),\r\n  [Min1]                VARCHAR(255),\r\n  [Max1]                VARCHAR(255),\r\n  [Avg1]                VARCHAR(255),\r\n  [FalseCount]          INT,\r\n  [TrueCount]           INT,\r\n  [Avg_Voltage]         DECIMAL(5, 4),\r\n  [SensorMessageCount]  INT,\r\n  [AwareStateCounts]    INT,\r\n  [SignalStrength] INT\r\n);\r\n\r\n\r\nCREATE INDEX [IDX_Temp1] ON #PreAgg (AccountID, Year, Month, Day, SensorID);\r\nCREATE INDEX [IDX_Temp2] ON #PreAgg (AccountID, Year, Month, Day, CSNetID);\r\n\r\nCREATE TABLE #AwareStates\r\n(\r\n  [SensorID]          BIGINT,\r\n  [Day]               INT,\r\n  [Month]             INT,\r\n  [Year]              INT,\r\n  [AwareStateCounts]  INT\r\n);\r\n\r\nCREATE TABLE #Offsets\r\n(\r\n  [RowID]   INT IDENTITY(1,1),\r\n  [Offset]  INT \r\n);\r\n\r\nCREATE TABLE #Group\r\n( \r\n  [RowID]             INT IDENTITY (1,1),\r\n  [TimeZoneID]        INT,\r\n  [TimeZoneIDString]  VARCHAR(255),\r\n  [LastInsertToDate]  DATETIME,\r\n  [InsertToDate]      DATETIME\r\n);\r\n\r\nCREATE TABLE #DM\r\n(\r\n  [MessageDate]       DATETIME,\r\n  [DataMessageGUID]   UNIQUEIDENTIFIER,\r\n  [SensorID]          INT,\r\n  [InsertDate]        DATETIME,\r\n  [TimeZoneIDString]  VARCHAR(255)\r\n);\r\n\r\nCREATE INDEX [IDX_Temp1] ON #DM (MessageDate);\r\n\r\nCREATE TABLE #Results\r\n(\r\n  [MessageDate] DATETIME,  \r\n  [MessageDate2] Datetime,\r\n  [SensorID]    BIGINT,    \r\n  [State]       BIGINT,   \r\n  [data]        VARCHAR(500),     \r\n  [Voltage]     DECIMAL(18,5),   \r\n  [SignalStrength] INT,   \r\n  [InsertDate]  DATETIME\r\n);\r\n        \r\n/********************************************************\r\n\r\n                  PROC BASED PARAMETERS\r\n\r\n*********************************************************/   \r\n\r\n\r\n\r\n    SELECT \r\n      s.[AccountID], \r\n      s.[SensorID], \r\n      s.LastCommunicationDate,\r\n      s.[CSNetID], \r\n      ma.[ApplicationName], \r\n      ma.[ApplicationID],\r\n      t.TimeZoneID,\r\n      t.TimeZoneIDString\r\n    INTO #sensorlist\r\n    FROM dbo.[Sensor] s WITH (NOLOCK)\r\n    INNER JOIN dbo.[Application] ma  WITH (NOLOCK) ON ma.[ApplicationID] = s.[ApplicationID]\r\n    INNER JOIN dbo.[Account] a  WITH (NOLOCK) ON s.[AccountID] = a.[AccountID]\r\n    INNER JOIN dbo.TimeZone t WITH (NOLOCK) on a.TimeZoneID = t.TimeZoneID\r\n    WHERE s.SensorID = @SensorID\r\n\r\n\r\n/***************************************************************\r\n                    GET DATA MESSAGES\r\n\r\n  This is the most intenstive hit to the database in the proc.\r\n  Because gateways can store old data messages, and insert them\r\n  after the day is over, we deciced to operate off of the insert\r\n  date, allow up to 2 calandar months (see above) to get data in.\r\n\r\n  This takes all the messages for the timze zone inserted from \r\n  the previous interations 'to date' to the currently generated to\r\n  date, typically should be a 24 hour window except if job failed\r\n  in previous interation.\r\n\r\n  Loops over each time zone because the insert date can vary.Gets the\r\n  PK values via the insert index, and then gets the data via the PK\r\n  index.\r\n\r\n* ***************************************************************/\r\n\r\n        SET @SQL =\r\n        'SELECT\r\n          d.MessageDate,\r\n          d.DataMessageGUID,\r\n          d.sensorid,\r\n          d.InsertDate,\r\n          s.TimeZoneIDString\r\n        FROM DataMessage d WITH(NOLOCK)\r\n        INNER JOIN #SensorList s on d.SensorID = s.SensorID\r\n        WHERE  InsertDate >= ''' + CONVERT(VARCHAR(25), @FromDate) +''' AND InsertDate < '''+ CONVERT(VARCHAR(25), @ToDate)+ '''\r\n        AND MessageDate >= '''+ CONVERT(VARCHAR(25), @FromDate)+''' AND MessageDate <= ''' + CONVERT(VARCHAR(25), @ToDate)+ '''';\r\n\r\n        print @sql;\r\n\r\n        INSERT INTO #DM\r\n        EXEC(@SQL);\r\n\r\n\r\n\r\n    SET @sql =\r\n    'SELECT\r\n        d.MessageDate,\r\n        MessageDate2 = dm.MessageDate,\r\n        dm.SensorID,\r\n        dm.State,\r\n        dm.Data,\r\n        dm.Voltage,\r\n        dm.InsertDate,\r\n        dm.SignalStrength\r\n      FROM #DM d\r\n      INNER JOIN DataMessage dm WITH(NOLOCK) ON d.SensorID = dm.SensorID and d.MessageDate = dm.MessageDate and d.DataMessageGUID = dm.DataMessageGUID\r\n      WHERE d.MessageDate >= '''+ CONVERT(VARCHAR(30), @FromDate, 120) +''' AND d.MessageDate <= ''' +  CONVERT(VARCHAR(30),DATEADD(second, -1, dateadd(month, 1, @FromDate)), 120) +  '''';\r\n\r\n\r\n        print @sql;\r\n\r\n\r\n    INSERT INTO #Results (\r\n       [MessageDate],\r\n       MessageDate2,\r\n       [SensorID],\r\n       [State],\r\n       [data],\r\n       [Voltage],\r\n       [InsertDate],\r\n       [SignalStrength]\r\n     )\r\n     EXEC(@sql);\r\n\r\n\r\n      INSERT INTO #tempresults (\r\n        [AccountID], \r\n        [SensorID], \r\n        [CSNetID], \r\n        [Year],\r\n        [Month], \r\n        [Day], \r\n        [data], \r\n        [Voltage], \r\n        [state],\r\n        [ApplicationID], \r\n        [ApplicationName],\r\n        [SignalStrength]\r\n       )\r\n      SELECT\r\n        sa.[AccountID],\r\n        dm.[SensorID],\r\n        sa.[CSNetID],\r\n        [Year]        = DATEPART(YEAR,  [MessageDate]),\r\n        [Month]       = DATEPART(MONTH, [MessageDate]),\r\n        [Day]         = DATEPART(DAY,   [MessageDate]),\r\n        [data],\r\n        [Voltage],\r\n        dm.[state],\r\n        sa.[ApplicationID],\r\n        sa.[ApplicationName],\r\n        dm.[SignalStrength]\r\n      FROM #Results dm\r\n      INNER JOIN #sensorlist sa WITH (NOLOCK) ON sa.[SensorID] = dm.[SensorID];\r\n      \r\n\r\n    BEGIN TRY\r\n        /*\r\n          ApplicationID 2 - Temperature Sensors\r\n        */\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data] = CONVERT(DECIMAL(8, 2), [Data]),\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        FROM #tempresults t\r\n        INNER JOIN (SELECT rowid FROM #tempresults WHERE [ApplicationID] = 2) t2 ON t.RowID = t2.RowID\r\n        WHERE t.ApplicationID = 2\r\n          AND ISNUMERIC(t.[Data])   = 1;\r\n\r\n            /*:21\r\n\r\n              Scrub records of bad data such as 'Improper Battery Replacements' \r\n              which are -999.0\r\n\r\n              puts value at null but keeps record so data won't factor \r\n              into min/max/avg but sensorcounts/aware states are kept\r\n            */\r\n            UPDATE #Holding\r\n          SET[data1] = NULL\r\n        WHERE[data1] <= -100 \r\n           OR[data1] >=  300;\r\n       \r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName] = 'Temperature',\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          'Temperature',\r\n          [MinTemp] = MIN(CONVERT(DECIMAL(18, 4), t1.[Data1])),\r\n          [MaxTemp] = Max(CONVERT(DECIMAL(18, 4), t1.[Data1])),\r\n          [AvgTemp] = AVG(CONVERT(DECIMAL(18, 4), t1.[Data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day]\r\n        ORDER BY t1.[SensorID], t1.[Year], t1.[Month], t1.[Day]\r\n\r\n    TRUNCATE TABLE #Holding\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n        SET @errormessage = @errormessage + 'Application 2'\r\n\r\n    END CATCH\r\n\r\n    /*\r\n      ApplicationID 35 - High Temperature Sensors\r\n    */\r\n    BEGIN TRY\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data] = CONVERT(DECIMAL(8, 2), [Data]),\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        FROM #tempresults t\r\n        INNER JOIN (SELECT RowID FROM #tempresults WHERE [ApplicationID] = 35) t2 ON t.RowID = t2.RowID\r\n        WHERE t.[ApplicationID] = 35\r\n          AND ISNUMERIC(t.[Data])     = 1\r\n\r\n\r\n        UPDATE #Holding\r\n          SET [data1] = NULL\r\n        WHERE[data1] <= -100 \r\n           OR[data1] >=  650\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName] = 'Temperature',\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          'Temperature',\r\n          [MinTemp] = MIN(CONVERT(DECIMAL(18, 4), t1.[Data1])),\r\n          [MaxTemp] = Max(CONVERT(DECIMAL(18, 4), t1.[Data1])),\r\n          [AvgTemp] = AVG(CONVERT(DECIMAL(18, 4), t1.[Data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG( [SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day]\r\n        ORDER BY t1.[SensorID], t1.[Year], t1.[Month], t1.[Day]\r\n\r\n    TRUNCATE TABLE #Holding\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n        set @ErrorMessage = @ErrorMessage + ' Application 35'\r\n\r\n    END CATCH\r\n\r\n    /*\r\n      Application 84 - Duct Temp\r\n    */\r\n\r\n    BEGIN TRY\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data] = CONVERT(DECIMAL(8, 2), [Data]),\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        FROM #tempresults t\r\n        INNER JOIN (SELECT rowid FROM #tempresults where [ApplicationID] = 84) t2 ON t.RowID = t2.RowID\r\n        WHERE t.[ApplicationID] = 84\r\n          AND ISNUMERIC(t.[Data])     = 1\r\n\r\n        UPDATE #Holding\r\n          SET [data1] = NULL\r\n        WHERE[data1] <= -100 \r\n           OR[data1] >=  650\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName] = 'Temperature',\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          'Temperature',\r\n          [MinTemp] = MIN(CONVERT(DECIMAL(18, 4), t1.[Data1])),\r\n          [MaxTemp] = Max(CONVERT(DECIMAL(18, 4), t1.[Data1])),\r\n          [AvgTemp] = AVG(CONVERT(DECIMAL(18, 4), t1.[Data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day]\r\n        ORDER BY t1.[SensorID], t1.[Year], t1.[Month], t1.[Day]\r\n\r\n    TRUNCATE TABLE #Holding\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n        set @ErrorMessage = @ErrorMessage + ' Application 84'\r\n\r\n    END CATCH\r\n\r\n    /*\r\n      Application 65 - Water Temp\r\n    */\r\n    BEGIN TRY\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data] = CONVERT(DECIMAL(8, 2), [Data]),\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        FROM #tempresults t\r\n        INNER JOIN (SELECT RowID FROM #tempresults where [ApplicationID] = 65) t2 ON t.RowID = t2.RowID\r\n        WHERE t.[ApplicationID] = 65\r\n          AND ISNUMERIC(t.[Data])     = 1\r\n\r\n\r\n        UPDATE #Holding\r\n          SET [data1] = NULL\r\n        WHERE[data1] <= -100 \r\n           OR[data1] >=  650\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName] = 'Temperature',\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          'Temperature',\r\n          [MinTemp] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [MaxTemp] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [AvgTemp] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[YEar],\r\n          t1.[Month],\r\n          t1.[Day]\r\n        ORDER BY t1.[SensorID], t1.[Year], t1.[Month], t1.[Day]\r\n\r\n    TRUNCATE TABLE #Holding\r\n\r\n    \r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n        set @ErrorMessage = @ErrorMessage + ' Application 65'\r\n\r\n    END CATCH\r\n\r\n    /*\r\n      Application 46 - Low Temp\r\n    */\r\n    BEGIN TRY\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data] = CONVERT(DECIMAL(8, 2), [Data]),\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        FROM #tempresults t\r\n        INNER JOIN (SELECT RowID FROM #tempresults WHERE [ApplicationID] = 46) t2 on t.RowID = t2.RowID\r\n        WHERE t.[ApplicationID] = 46\r\n          AND ISNUMERIC(t.[Data])     = 1\r\n\r\n\r\n        UPDATE #Holding\r\n          SET [data1] = NULL\r\n        WHERE[data1] <= -250 \r\n           OR[data1] >=  650\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName] = 'Temperature',\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          'Temperature',\r\n          [MinTemp] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [MaxTemp] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [AvgTemp] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day]\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day]\r\n\r\n    TRUNCATE TABLE #Holding\r\n\r\n       \r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n        set @ErrorMessage = @ErrorMessage + ' Application 46'\r\n\r\n    END CATCH\r\n\r\n    /*\r\n\r\n      Application 24 - Flex\r\n\r\n    */\r\n    BEGIN TRY\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data] = CONVERT(DECIMAL(8, 2), [Data]),\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        FROM #tempresults t\r\n        INNER JOIN (SELECT RowID FROM #tempresults WHERE [ApplicationID] = 24) t2 ON t.RowID = t2.RowID AND ISNUMERIC(t.[Data]) = 1\r\n\r\n        UPDATE h\r\n          SET[Data1] = NULL\r\n        FROM #Holding h\r\n        WHERE State & 16 = 16\r\n\r\n        UPDATE H\r\n          Set[Data1] = CASE WHEN h.[Data1] <= CONVERT(Decimal(6,3), ISNULL(sa.[Value], 1))  THEN 0.00 \r\n                              WHEN h.[Data1] >= CONVERT(Decimal(6,3), ISNULL(sa2.[Value], 35))  THEN 100.00\r\n                              WHEN CONVERT(Decimal(6,3), ISNULL(sa2.[Value],35)) - CONVERT(Decimal(6,3), ISNULL(sa.[Value], 1)) = 0 then 0\r\n                              ELSE((h.[Data1] - CONVERT(DECIMAL(6,3), sa.[Value]) ) / (CONVERT(Decimal(6,3), ISNULL(sa2.[Value],35)) - CONVERT(Decimal(6,3), ISNULL(sa.[Value], 1)))) * 100 \r\n                              END\r\n        FROM #Holding h\r\n        LEFT JOIN SensorAttribute sa  WITH(NOLOCK) ON h.sensorid =  sa.SensorID AND  sa.Name = 'MinBend'\r\n\r\n       LEFT JOIN SensorAttribute sa2 WITH (NOLOCK) ON h.sensorid = sa2.SensorID AND sa2.Name = 'MaxBend'\r\n\r\n\r\n        /*3:46\r\n\r\n          PreAgg - Temperature\r\n\r\n        Get the PreAgg data FROM the segmented Temp table\r\n        */\r\n       INSERT INTO  #PreAgg\r\n        (\r\n\r\n         [AccountID],\r\n\r\n         [SensorID],\r\n\r\n         [ApplicationName],\r\n\r\n         [ApplicationID],\r\n\r\n         [CSNetID],\r\n\r\n         [Year],\r\n\r\n         [Month],\r\n\r\n         [Day],\r\n\r\n         [SplitValue],\r\n\r\n         [Min1],\r\n\r\n         [Max1],\r\n\r\n         [Avg1],\r\n\r\n         [Avg_Voltage],\r\n\r\n         [SensorMessageCount],\r\n\r\n         [SignalStrength]\r\n       )\r\n       SELECT\r\n\r\n         t1.[AccountID],\r\n         t1.[SensorID],\r\n         t1.[ApplicationName],\r\n         t1.[ApplicationID],\r\n         t1.[CSNetID],\r\n         t1.[Year],\r\n         t1.[Month],\r\n         t1.[Day],\r\n          'Flex Percentage',\r\n         [MinTemp] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n         [MaxTemp] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n         [AvgTemp] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n         [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          t1.[ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day]\r\n        ORDER BY t1.[SensorID], t1.[Year], t1.[Month], t1.[Day]\r\n\r\n    TRUNCATE TABLE #Holding\r\n       \r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n        set @ErrorMessage = @ErrorMessage + ' Application 24'\r\n\r\n    END CATCH\r\n\r\n\r\n\r\n    BEGIN TRY\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1] = CONVERT(DECIMAL(8, 2), substring([Data], 0, charindex(',', data, 0))), \r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE [ApplicationID] = 48) t2 on t.RowID = t2.RowID\r\n        WHERE t.[ApplicationID] = 48\r\n          AND ISNUMERIC(CONVERT(DECIMAL(8,2), substring([Data], 0, charindex(',', data, 0))))     = 1\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName] = 'Pulse Counter',\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Pulses',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day]\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        set @ErrorMessage = @ErrorMessage + ' Application 48'\r\n\r\n    END CATCH\r\n\r\n    BEGIN TRY\r\n\r\n    UPDATE t SET\r\n          [data] =substring([Data], 0, charindex(',', data, 0))\r\n        FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE [ApplicationID] = 52) t2 on t.RowID = t2.RowID\r\n        WHERE t.[ApplicationID] = 52\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n\r\n        set @ErrorMessage = @ErrorMessage + ' Application 52'\r\n\r\n    END CATCH\r\n\r\n\r\n\r\n\r\n    BEGIN TRY\r\n\r\n    UPDATE t SET\r\n          [data] = CASE WHEN substring([Data], 0, charindex('|', data, 0)) = 1 THEN 'True' ELSE CASE WHEN substring([Data], 0, charindex('|', data, 0)) = '2' AND\r\n                     substring([Data], charindex('|', data, 0)+1, charindex('|', data, charindex('|', data, 0   ) )) != 0 THEN 'True' ELSE 'False' END END\r\n        FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE [ApplicationID] = 119) t2 on t.RowID = t2.RowID\r\n        WHERE t.[ApplicationID] = 119\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n\r\n        set @ErrorMessage = @ErrorMessage + ' Application 119'\r\n\r\n    END CATCH\r\n\r\n\r\n    BEGIN TRY\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1] = CONVERT(DECIMAL(8, 2), substring([Data], 0, charindex('|', data, 0))), \r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE [ApplicationID] = 97) t2 on t.RowID = t2.RowID\r\n        WHERE t.[ApplicationID] = 97\r\n          AND ISNUMERIC(CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))))     = 1\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName] = 'Thermostat',\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Temperature',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day]\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        set @ErrorMessage = @ErrorMessage + ' Application 97'\r\n\r\n    END CATCH\r\n\r\n\r\n\r\n\r\n    BEGIN TRY\r\n\r\n\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Data2],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day], \r\n          [data1] = CONVERT(DECIMAL(8,2), substring([Data], 0, charindex(',', data, 0))), \r\n          [data2] = CONVERT(DECIMAL(8,2), dbo.SplitIndex(data, ',', 1)) , \r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (75)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (75)\r\n          AND ISNUMERIC(CONVERT(DECIMAL(8,2), substring([Data], 0, charindex(',', data, 0))))     = 1\r\n\r\n        UPDATE #Holding \r\n        SET Data1 = NULL, Data2 = NULL\r\n        WHERE State & 16 = 16\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Pitch',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            insert into  #PreAgg\r\n        (\r\n             [AccountID],\r\n             [SensorID] ,\r\n             [ApplicationName],\r\n             [ApplicationID],\r\n             [CSNetID],\r\n             [Year],\r\n             [Month],\r\n             [Day] ,\r\n             [SplitValue],\r\n             [Min1],\r\n             [Max1],\r\n             [Avg1],\r\n             [Avg_Voltage],\r\n             [SensorMessageCount],\r\n             [SignalStrength]\r\n\r\n           )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Roll',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 75'\r\n\r\n    END CATCH\r\n\r\n\r\n\r\n    BEGIN TRY\r\n\r\n\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [data2],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day], \r\n          [data1] =  substring([Data], 0, charindex('|', data, 0)), \r\n          [data2] =  substring([Data], charindex('|', data, 0)+1, charindex('|', data, charindex('|', data, 0))+2),\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (103)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (103)\r\n          AND ISNUMERIC(CONVERT(DECIMAL(8,2),  substring([Data], 0, charindex('|', data, 0))))     = 1\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'DifferentialPressure',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            insert into  #PreAgg\r\n        (\r\n              [AccountID],\r\n              [SensorID] ,\r\n              [ApplicationName],\r\n              [ApplicationID],\r\n              [CSNetID],\r\n              [Year],\r\n              [Month],\r\n              [Day] ,\r\n              [SplitValue],\r\n              [Min1],\r\n              [Max1],\r\n              [Avg1],\r\n              [Avg_Voltage],\r\n              [SensorMessageCount],\r\n              [SignalStrength]\r\n\r\n            )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Temperature',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 103'\r\n\r\n    END CATCH\r\n\r\n\r\n\r\n    BEGIN TRY\r\n\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day],\r\n          [data1] =  CONVERT(DECIMAL(18,2), substring([Data], 0, charindex(',', data, 0))), \r\n          [data2] =  CONVERT(DECIMAL(18,2), substring(data, charindex(',', data,  0 ) +1, charindex(',', data, charindex(',', data, 0) +1   )  - charindex(',', data,  0 )-1 )),\r\n          [data3] =  CONVERT(DECIMAL(18,2), substring(data, charindex(',', data, charindex(',', data, 0) +1   ) +1,  charindex(',', data, charindex(',', data, charindex(',', data, 0) +1  ) +1   )  - charindex(',', data, charindex(',', data, 0) +1   )-1 )),\r\n          [data4] =  CONVERT(DECIMAL(18,2), substring(data, charindex(',', data, charindex(',', data, charindex(',', data, 0) +1 ) +1   ) +1,  20)),\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            INTO #HoldingProbes2\r\n        FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (92)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (92)\r\n          AND ISNUMERIC(substring([Data], 0, charindex(',', data, 0)))     = 1\r\n                  \r\n      update #HoldingProbes2 set Data1 = NULL where Data1 < - 990.0\r\n      \r\n      update #HoldingProbes2 set Data2 = NULL where Data2 < - 990.0\r\n      \r\n      update #HoldingProbes2 set Data3 = NULL where Data3 < - 990.0\r\n      \r\n      update #HoldingProbes2 set Data4 = NULL where Data4 < - 990.0\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Probe1',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #HoldingProbes2 t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n\r\n            insert into  #PreAgg\r\n        (\r\n              [AccountID],\r\n              [SensorID] ,\r\n              [ApplicationName],\r\n              [ApplicationID],\r\n              [CSNetID],\r\n              [Year],\r\n              [Month],\r\n              [Day] ,\r\n              [SplitValue],\r\n              [Min1],\r\n              [Max1],\r\n              [Avg1],\r\n              [Avg_Voltage],\r\n              [SensorMessageCount],\r\n              [SignalStrength]\r\n\r\n            )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Probe2',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #HoldingProbes2 t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n\r\n            insert into  #PreAgg\r\n        (\r\n              [AccountID],\r\n              [SensorID] ,\r\n              [ApplicationName],\r\n              [ApplicationID],\r\n              [CSNetID],\r\n              [Year],\r\n              [Month],\r\n              [Day] ,\r\n              [SplitValue],\r\n              [Min1],\r\n              [Max1],\r\n              [Avg1],\r\n              [Avg_Voltage],\r\n              [SensorMessageCount],\r\n              [SignalStrength]\r\n\r\n            )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Probe3',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data3])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data3])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data3])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #HoldingProbes2 t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n\r\n            insert into  #PreAgg\r\n        (\r\n              [AccountID],\r\n              [SensorID] ,\r\n              [ApplicationName],\r\n              [ApplicationID],\r\n              [CSNetID],\r\n              [Year],\r\n              [Month],\r\n              [Day] ,\r\n              [SplitValue],\r\n              [Min1],\r\n              [Max1],\r\n              [Avg1],\r\n              [Avg_Voltage],\r\n              [SensorMessageCount],\r\n              [SignalStrength]\r\n\r\n            )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Probe4',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data4])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data4])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data4])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #HoldingProbes2 t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            drop TABLE #HoldingProbes2;\r\n\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 92'\r\n\r\n    END CATCH\r\n\r\n\r\n\r\n    BEGIN TRY\r\n\r\n\r\n\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day],\r\n          [data1] =  CONVERT(DECIMAL(18,2), substring([Data], 0, charindex(',', data, 0))), \r\n          [data2] =  CONVERT(DECIMAL(18,2), substring(data, charindex(',', data,  0 ) +1, charindex(',', data, charindex(',', data, 0) +1   )  - charindex(',', data,  0 )-1 )),\r\n          [data3] =  CONVERT(DECIMAL(18,2), substring(data, charindex(',', data, charindex(',', data, 0) +1   ) +1,  charindex(',', data, charindex(',', data, charindex(',', data, 0) +1  ) +1   )  - charindex(',', data, charindex(',', data, 0) +1   )-1 )),\r\n          [data4] =  CONVERT(DECIMAL(18,2), substring(data, charindex(',', data, charindex(',', data, charindex(',', data, 0) +1 ) +1   ) +1,  20)),\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            INTO #HoldingProbes\r\n        FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (47)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (47)\r\n          AND ISNUMERIC(substring([Data], 0, charindex(',', data, 0)))     = 1\r\n              \r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Count1',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #HoldingProbes t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n\r\n            insert into  #PreAgg\r\n        (\r\n              [AccountID],\r\n              [SensorID] ,\r\n              [ApplicationName],\r\n              [ApplicationID],\r\n              [CSNetID],\r\n              [Year],\r\n              [Month],\r\n              [Day] ,\r\n              [SplitValue],\r\n              [Min1],\r\n              [Max1],\r\n              [Avg1],\r\n              [Avg_Voltage],\r\n              [SensorMessageCount],\r\n              [SignalStrength]\r\n\r\n            )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Count2',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #HoldingProbes t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n\r\n            insert into  #PreAgg\r\n        (\r\n              [AccountID],\r\n              [SensorID] ,\r\n              [ApplicationName],\r\n              [ApplicationID],\r\n              [CSNetID],\r\n              [Year],\r\n              [Month],\r\n              [Day] ,\r\n              [SplitValue],\r\n              [Min1],\r\n              [Max1],\r\n              [Avg1],\r\n              [Avg_Voltage],\r\n              [SensorMessageCount],\r\n              [SignalStrength]\r\n\r\n            )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Count3',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data3])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data3])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data3])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #HoldingProbes t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n\r\n            insert into  #PreAgg\r\n        (\r\n              [AccountID],\r\n              [SensorID] ,\r\n              [ApplicationName],\r\n              [ApplicationID],\r\n              [CSNetID],\r\n              [Year],\r\n              [Month],\r\n              [Day] ,\r\n              [SplitValue],\r\n              [Min1],\r\n              [Max1],\r\n              [Avg1],\r\n              [Avg_Voltage],\r\n              [SensorMessageCount],\r\n              [SignalStrength]\r\n\r\n            )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Count4',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data4])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data4])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data4])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #HoldingProbes t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            drop TABLE #HoldingProbes;\r\n\r\n        TRUNCATE TABLE #Holding;\r\n\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 47'\r\n\r\n    END CATCH\r\n\r\n\r\n\r\n    BEGIN TRY\r\n\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day],\r\n          [data1] = CONVERT(DECIMAL(18,2), substring([Data], 0, charindex('|', data, 0))), \r\n          [data2] = CONVERT(DECIMAL(18,2), substring(data, charindex('|', data,  0 ) +1, charindex('|', data, charindex('|', data, 0) +1   )  - charindex('|', data,  0 )-1 )),\r\n          [data3] = CONVERT(DECIMAL(18,2), substring(data, charindex('|', data, charindex('|', data, 0) +1   ) +1,  charindex('|', data, charindex('|', data, charindex('|', data, 0) +1  ) +1   )  - charindex('|', data, charindex('|', data, 0) +1   )-1 )),\r\n          [data4] = CONVERT(INT, substring(data, charindex('|', data, charindex('|', data, charindex('|', data, 0) +1 ) +1   ) +1,  20)),\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            INTO #HoldingProbes3\r\n        FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (135)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (135)\r\n          AND ISNUMERIC(substring([Data], 0, charindex('|', data, 0)))     = 1\r\n\r\n\r\n          update #HoldingProbes3 set data2 = null where data4 & 12 != 0\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Moisture',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #HoldingProbes3 t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n\r\n            insert into  #PreAgg\r\n        (\r\n              [AccountID],\r\n              [SensorID] ,\r\n              [ApplicationName],\r\n              [ApplicationID],\r\n              [CSNetID],\r\n              [Year],\r\n              [Month],\r\n              [Day] ,\r\n              [SplitValue],\r\n              [Min1],\r\n              [Max1],\r\n              [Avg1],\r\n              [Avg_Voltage],\r\n              [SensorMessageCount],\r\n              [SignalStrength]\r\n\r\n            )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Temperature',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data2])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #HoldingProbes3 t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n\r\n\r\n            drop TABLE #HoldingProbes3;\r\n        \r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 135'\r\n\r\n    END CATCH\r\n\r\n\r\n    BEGIN TRY\r\n\r\n\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          Data2,\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day],\r\n          [data1] =  substring([Data], 0, charindex('|', data, 0)), \r\n          [data2] =  substring([Data], charindex('|', data, charindex('|', data, 0)+ 1 )+1, charindex('|', data, charindex('|', data, 0))+1),\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (124)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (124)\r\n          AND ISNUMERIC(substring([Data], 0, charindex('|', data, 0)))     = 1\r\n                  \r\n      update #holding set Data1 = NULL where Data2 = 1\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Percentage',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 124'\r\n\r\n    END CATCH\r\n\r\n    BEGIN TRY\r\n\r\n\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day], \r\n          [data1] = CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))), \r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (102)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (102)\r\n          AND ISNUMERIC(CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))))     = 1\r\n\r\n        UPDATE #Holding \r\n        SET Data1 = NULL\r\n        WHERE State > 0 and state< 6\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'PM25',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 102'\r\n\r\n    END CATCH\r\n\r\n    BEGIN TRY\r\n\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [ApplicationName],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day], \r\n          [data1] = CONVERT(DECIMAL(18,2), dbo.SplitIndex(data, '|',12 )), \r\n          [ApplicationName],\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE [ApplicationID] in (109,129,137)) t2 on t.RowID = t2.RowID\r\n        WHERE t.[ApplicationID]in (109,129,137)\r\n          AND ISNUMERIC(CONVERT(DECIMAL(18,2), dbo.SplitIndex(data, '|',12 )))     = 1\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Amp Hours',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 109'\r\n\r\n    END CATCH\r\n\r\n\r\n\r\n    BEGIN TRY\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [data2],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day], \r\n          [data1] = CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))), \r\n          [data2] =  substring(data, charindex('|', data, charindex('|', data, 0   ) +1   ) +1, charindex('|', data, 0   )) ,\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE [ApplicationID] = 128) t2 on t.RowID = t2.RowID\r\n        WHERE t.[ApplicationID] = 128\r\n          AND ISNUMERIC(CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))))     = 1\r\n\r\n        update #Holding\r\n        set data1 = null\r\n        where data2 in (1,2,3)\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName] = 'Food Probe',\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Temperature',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day]\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'Error Application 128'\r\n\r\n    END CATCH\r\n\r\n\r\n\r\n    BEGIN TRY\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [data2],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day], \r\n          [data1] = CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))), \r\n          [data2] =  substring(data, charindex('|', data, charindex('|', data, 0   ) +1   ) +1, charindex('|', data, 0   )) ,\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE [ApplicationID] = 136) t2 on t.RowID = t2.RowID\r\n        WHERE t.[ApplicationID] = 136\r\n          AND ISNUMERIC(CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))))     = 1\r\n\r\n        update #Holding\r\n        set data1 = null\r\n        where data2 in (1,2,3)\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName] = 'Digital Temperature',\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Temperature',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day]\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'Error Application 136'\r\n\r\n    END CATCH\r\n\r\n\r\n\r\n    BEGIN TRY\r\n\r\n\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Data2],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day], \r\n          [data1] =  CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))),\r\n          [Data2] = substring(data, charindex('|', data, charindex('|', data, 0   ) +1   ) +1, charindex('|', data, 0   )) ,\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (106)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (106)\r\n          AND ISNUMERIC(CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))))     = 1\r\n                  \r\n        update #Holding\r\n        SET data1 = NULL\r\n        WHERE data2 in (1,2,3,4,6)\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'CO2 Instantaneous',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 106'\r\n\r\n    END CATCH\r\n\r\n    \r\n    \r\n    BEGIN TRY\r\n\r\n    \r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [data2],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day], \r\n          [data1] =  CONVERT(DECIMAL(18,2), substring([Data], 0, charindex('|', data, 0))), \r\n          [data2] =  CONVERT(Decimal(18,2), substring(data, charindex('|', data, charindex('|', data, charindex('|', data,  charindex('|', data, 0) +1   ) +1) +1) +1,  len(data))),\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        FROM #tempresults t\r\n        INNER JOIN (SELECT RowID FROM #tempresults WHERE applicationid in (139)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (139)\r\n          AND  ISNUMERIC(CONVERT(DECIMAL(8,2),  substring([Data], 0, charindex('|', data, 0))))     = 1\r\n\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'PPFD',\r\n          [Min] = MIN(CONVERT(DECIMAL(18,4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18,4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18,4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY \r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID],[Year], t1.[Month], t1.[Day];        \r\n\r\n        --to be used when DLI goes live\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'DLI',\r\n          [Min] = MIN(CONVERT(DECIMAL(18,4), t1.[data2])),\r\n          [Max] = Max(CONVERT(DECIMAL(18,4), t1.[data2])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18,4), t1.[data2])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY \r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID],[Year], t1.[Month], t1.[Day];\r\n\r\n\r\n        TRUNCATE TABLE #Holding;\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n    \r\n        SET @errormessage = @errormessage +  'error application 139'\r\n\r\n    END CATCH\r\n\r\n    BEGIN TRY\r\n\r\n\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Data2],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day], \r\n          [data1] =  CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))),\r\n          [Data2] = substring(data, charindex('|', data, charindex('|', data, charindex('|', data, charindex('|', data, 0   ) +1   )+  1 ) +1   ) +1, charindex('|', data, 0   )),\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (116)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (116)\r\n          AND ISNUMERIC(CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))))     = 1\r\n                  \r\n        update #Holding\r\n        SET data1 = NULL\r\n        WHERE data2 in (5,12,13,14,15)\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'CO Instantaneous',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 106'\r\n\r\n    END CATCH\r\n\r\n    BEGIN TRY\r\n\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Data2],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day], \r\n          [data1] = CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))), \r\n          [data2] =  substring(data, charindex('|', data, charindex('|', data, 0   ) +1   ) +1, charindex('|', data, 0   )) , \r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (67,105)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (67,105)\r\n          AND ISNUMERIC(CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))))     = 1\r\n\r\n        UPDATE #Holding \r\n        SET Data1 = NULL\r\n        WHERE Data2 in (4)\r\n\r\n         UPDATE #Holding \r\n        SET Data1 = NULL\r\n        WHERE Data1 in (65535.00)\r\n\r\n        \r\n\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Distance',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 67,105'\r\n\r\n    END CATCH\r\n\r\n\r\n\r\n    BEGIN TRY\r\n\r\n\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day],\r\n          [data1] =  substring([Data], 0, charindex('|', data, 0)), \r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (130)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (130)\r\n          AND ISNUMERIC(substring([Data], 0, charindex('|', data, 0)))     = 1\r\n                  \r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Pitch',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 130'\r\n\r\n    END CATCH\r\n\r\n\r\n\r\n    BEGIN TRY\r\n\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day],\r\n          [data1] =  CONVERT(DECIMAL(18,2), Data), \r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (83)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (83)\r\n          AND ISNUMERIC(CONVERT(DECIMAL(18,2), Data))     = 1\r\n                  \r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Pressure',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 83'\r\n\r\n    END CATCH\r\n\r\n\r\n    BEGIN TRY\r\n\r\n\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day], \r\n          [data1] =  CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))),\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (114)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (114)\r\n          AND ISNUMERIC(CONVERT(DECIMAL(8,2), substring([Data], 0, charindex('|', data, 0))))     = 1\r\n                  \r\n        update #Holding\r\n        SET data1 = NULL\r\n        WHERE State = 16\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Airspeed',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 114'\r\n\r\n    END CATCH\r\n\r\n\r\n    BEGIN TRY\r\n\r\n\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day], \r\n          [data1] =  CONVERT(DECIMAL(8,2), Data),\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (113)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (113)\r\n          AND ISNUMERIC(CONVERT(DECIMAL(8,2), Data))     = 1\r\n                  \r\n\r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Volts',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 113'\r\n\r\n    END CATCH\r\n\r\n\r\n\r\n    BEGIN TRY\r\n\r\n\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day],\r\n          [data1] =  convert(Decimal(18,2), data),\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE applicationid in (122)) t2 on t.RowID = t2.RowID\r\n        WHERE t.applicationid in (122)\r\n          AND ISNUMERIC(convert(Decimal(18,2), data))     = 1\r\n                  \r\n\r\n        insert into  #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName],\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Voltage',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day],\r\n        t1.ApplicationName\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day];\r\n\r\n            TRUNCATE TABLE #Holding;\r\n\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n\r\n        SET @errormessage = @errormessage + 'error application 122'\r\n\r\n    END CATCH\r\n\r\n\r\n    BEGIN TRY\r\n\r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day], \r\n          [data1] = CONVERT(DECIMAL(8,2), Data), \r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID],\r\n          [SignalStrength]\r\n            FROM #tempresults t\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE [ApplicationID] = 86) t2 on t.RowID = t2.RowID\r\n        WHERE t.[ApplicationID] = 86\r\n          AND ISNUMERIC(t.[Data])     = 1\r\n\r\n      UPDATE #Holding\r\n          SET [data1] = NULL\r\n        WHERE[data1] <= -201 \r\n            OR[data1] >=  1251;\r\n\r\n            INSERT INTO  #PreAgg\r\n        (\r\n              [AccountID],\r\n              [SensorID] ,\r\n              [ApplicationName],\r\n              [ApplicationID],\r\n              [CSNetID],\r\n              [Year],\r\n              [Month],\r\n              [Day] ,\r\n              [SplitValue],\r\n              [Min1],\r\n              [Max1],\r\n              [Avg1],\r\n              [Avg_Voltage],\r\n              [SensorMessageCount],\r\n              [SignalStrength]\r\n\r\n            )\r\n        SELECT\r\n          t1.[AccountID],\r\n          t1.[SensorID],\r\n          [ApplicationName] = 'Thermocouple',\r\n          t1.[ApplicationID],\r\n          t1.[CSNetID],\r\n          t1.[Year],\r\n          t1.[Month],\r\n          t1.[Day],\r\n          SplitValue = 'Temperature',\r\n          [Min] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Max] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding t1\r\n        GROUP BY\r\n        t1.[AccountID],\r\n        t1.[SensorID],\r\n        t1.[ApplicationID],\r\n        t1.[CSNetID],\r\n        t1.[Year],\r\n        t1.[Month],\r\n        t1.[Day]\r\n        ORDER BY t1.[SensorID], [Year], t1.[Month], t1.[Day]\r\n\r\n        TRUNCATE TABLE #Holding;\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n        set @ErrorMessage = @ErrorMessage + ' Application 86'\r\n\r\n    END CATCH\r\n\r\n    /*:19\r\n\r\n      ApplicationID 43 - Humidity ('Humidity Percent, Temperature')\r\n\r\n      Separates the Humidity AND Temp into two different columns for pre-agg each\r\n    */\r\n\r\n    BEGIN TRY\r\n\r\n        SELECT\r\n          RowID = ROW_NUMBER() OVER (PARTITION BY 1 ORDER BY SensorID, Data, AccountID),\r\n          [AccountID], \r\n          [SensorID], \r\n          [CSNetID], \r\n          [Year],\r\n          [Month], \r\n          [Day], \r\n          data,\r\n          [data1] = CONVERT(DECIMAL(18,2), substring([Data], 0, charindex(',', data, 0))),\r\n          [data2] =   case when applicationid = 43 then CONVERT(DECIMAL(18,2), substring(data, charindex(',', data,  0   )+1, charindex(',', data, charindex(',', data,  0   ) +1  )-charindex(',', data,  0   )-1)) \r\n          else    CONVERT(DECIMAL(18,2),substring(data, charindex(',', data,  0   )+1, len(data))) end,\r\n          [Voltage], \r\n          [state], \r\n          [ApplicationID], \r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            into #numerictester3\r\n        FROM #tempresults h\r\n        INNER JOIN(SELECT RowID FROM #tempresults WHERE ApplicationID in (18,29,43)) t2 on h.RowID = t2.RowID\r\n        --WHERE CHARINDEX(',', data, 0) != 0\r\n  \r\n        INSERT INTO #Holding\r\n        (\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [data2],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n        )\r\n\r\n        SELECT\r\n          [AccountID],\r\n          [SensorID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [data1],\r\n          [data2],\r\n          [Voltage],\r\n          [state],\r\n          [ApplicationID],\r\n          [ApplicationName],\r\n          [SignalStrength]\r\n            FROM #numerictester3\r\n\r\n        /*:01\r\n\r\n        Make sure to get rid of readings which are invalid, but keep the counts\r\n        */\r\n        UPDATE #Holding\r\n          SET[Data1] = NULL, [Data2] = NULL\r\nWHERE[Data1] = -100\r\n\r\n\r\n        /*:07\r\n\r\n          PreAgg - Humidity (Humidity)\r\n\r\n        Get the PreAgg data FROM the segmented Temp table\r\n\r\n        */\r\n        INSERT INTO #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID],\r\n          [SensorID],\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [SplitValue] = 'Humidity',\r\n          [MinTemp] = MIN(CONVERT(DECIMAL(18,4), [Data1])),\r\n          [MaxTemp] = Max(CONVERT(DECIMAL(18,4), [Data1])),\r\n          [AvgTemp] = AVG(CONVERT(DECIMAL(18,4), [Data1])),\r\n          [Avg_Voltage] = AVG([Voltage]),\r\n          [Counts] = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding\r\n        GROUP BY\r\n          [AccountID],\r\n          [SensorID],\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day]\r\n            ORDER BY[SensorID], [Year],[Month], [Day]\r\n\r\n        /*:05\r\n\r\n          PreAgg - Humidity (Temp)\r\n\r\n        Get the PreAgg data FROM the segmented Temp table\r\n        */\r\n        INSERT INTO #PreAgg\r\n        (\r\n          [AccountID],\r\n          [SensorID] ,\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day] ,\r\n          [SplitValue],\r\n          [Min1],\r\n          [Max1],\r\n          [Avg1],\r\n          [Avg_Voltage],\r\n          [SensorMessageCount],\r\n          [SignalStrength]\r\n        )\r\n        SELECT\r\n          [AccountID],\r\n          [SensorID],\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day],\r\n          [SplitValue]  = 'Temperature',\r\n          [MinTemp]     = MIN(CONVERT(DECIMAL(18,4), Data2)),\r\n          [MaxTemp]     = Max(CONVERT(DECIMAL(18,4), Data2)),\r\n          [AvgTemp]     = AVG(CONVERT(DECIMAL(18,4), Data2)),\r\n          [Avg_Voltage] = AVG(Voltage),\r\n          [Counts]      = COUNT(*),\r\n          FLOOR(AVG([SignalStrength]))\r\n        FROM #Holding\r\n        GROUP BY\r\n          [AccountID],\r\n          [SensorID],\r\n          [ApplicationName],\r\n          [ApplicationID],\r\n          [CSNetID],\r\n          [Year],\r\n          [Month],\r\n          [Day]\r\n            ORDER BY[SensorID], [Year],[Month], [Day]\r\n\r\n    TRUNCATE TABLE #Holding\r\n\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n        set @ErrorMessage = @ErrorMessage + ' Application 18,29,43'\r\n\r\n    END CATCH\r\n\r\n    /*\r\n      ApplicationID 26 - Liquid Lvel\r\n    */\r\n    BEGIN TRY\r\n\r\n    INSERT INTO #Holding\r\n    (\r\n      [AccountID],\r\n      [SensorID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [data1],\r\n      [Voltage],\r\n      [state],\r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      [AccountID], \r\n      [SensorID], \r\n      [CSNetID],\r\n      [Year], \r\n      [Month], \r\n      [Day], \r\n      [data] = CONVERT(DECIMAL(8,2), [Data]), \r\n      [Voltage], \r\n      [state], \r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      [SignalStrength]\r\n            FROM #tempresults t\r\n    INNER JOIN(SELECT RowID FROM #tempresults WHERE ApplicationID = 26) t2 on t.RowID = t2.RowID AND ISNUMERIC(t.[Data]) = 1\r\n\r\n    UPDATE h\r\n      SET [Data1] = NULL\r\n    FROM #Holding h\r\n    WHERE [Data1] <-100\r\n       OR[Data1] > 300\r\n\r\n\r\n    /*3:46\r\n\r\n      PreAgg - Temperature\r\n\r\n    Get the PreAgg data FROM the segmented Temp table\r\n    */\r\n    insert into  #PreAgg\r\n    (\r\n      [AccountID],\r\n      [SensorID],\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [SplitValue],\r\n      [Min1],\r\n      [Max1],\r\n      [Avg1],\r\n      [Avg_Voltage],\r\n      [SensorMessageCount],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      t1.[AccountID],\r\n      t1.[SensorID],\r\n      t1.[ApplicationName],\r\n      t1.[ApplicationID],\r\n      t1.[CSNetID],\r\n      t1.[Year],\r\n      t1.[Month],\r\n      t1.[Day],\r\n      'Inches',\r\n      [MinTemp] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [MaxTemp] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [AvgTemp] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [Avg_Voltage] = AVG([Voltage]),\r\n      [Counts] = COUNT(*),\r\n      FLOOR(AVG([SignalStrength]))\r\n    FROM #Holding t1\r\n    GROUP BY\r\n      t1.[AccountID],\r\n      t1.[SensorID],\r\n      t1.[ApplicationName],\r\n      t1.[ApplicationID],\r\n      t1.[CSNetID],\r\n      t1.[Year],\r\n      t1.[Month],\r\n      t1.[Day]\r\n    ORDER BY t1.[SensorID], t1.[Year], t1.[Month], t1.[Day]\r\n\r\n    TRUNCATE TABLE #Holding\r\n\r\n       \r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' Application 26'\r\n\r\n    END CATCH\r\n\r\n    /*\r\n      ApplicationID 26 - Liquid Lvel\r\n    */\r\n\r\n    BEGIN TRY\r\n\r\n    INSERT INTO #Holding\r\n    (\r\n      [AccountID],\r\n      [SensorID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [data1],\r\n      [Voltage],\r\n      [state],\r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      [AccountID],\r\n      [SensorID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [data] = CONVERT(DECIMAL(8, 2), SUBSTRING([Data], 0, CHARINDEX('|', [Data], 0))), \r\n      [Voltage], \r\n      [state], \r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      [SignalStrength]\r\n            FROM #tempresults t\r\n    INNER JOIN(SELECT RowID FROM #tempresults WHERE ApplicationID = 36) t2 on t.RowID = t2.RowID AND ISNUMERIC(SUBSTRING([Data], 0, CHARINDEX('|', [Data], 0) )) = 1\r\n\r\n    UPDATE h\r\n      SET [Data1] = NULL\r\n    FROM #Holding h\r\n    WHERE ([Data1] <-100\r\n       OR[Data1] > 300)\r\n\r\n\r\n    /*3:46\r\n\r\n      PreAgg - Temperature\r\n\r\n    Get the PreAgg data FROM the segmented Temp table\r\n    */\r\n    insert into  #PreAgg\r\n    (\r\n      [AccountID],\r\n      [SensorID] ,\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day] ,\r\n      [SplitValue],\r\n      [Min1],\r\n      [Max1],\r\n      [Avg1],\r\n      [Avg_Voltage],\r\n      [SensorMessageCount],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      t1.[AccountID],\r\n      t1.[SensorID],\r\n      t1.[ApplicationName],\r\n      t1.[ApplicationID],\r\n      t1.[CSNetID],\r\n      t1.[Year],\r\n      t1.[Month],\r\n      t1.[Day],\r\n      'Inches',\r\n      [MinTemp] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [MaxTemp] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [AvgTemp] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [Avg_Voltage] = AVG([Voltage]),\r\n      [Counts] = COUNT(*),\r\n      FLOOR(AVG([SignalStrength]))\r\n    FROM #Holding t1\r\n    GROUP BY\r\n      t1.[AccountID],\r\n      t1.[SensorID],\r\n      t1.[ApplicationName],\r\n      t1.[ApplicationID],\r\n      t1.[CSNetID],\r\n      t1.[Year],\r\n      t1.[Month],\r\n      t1.[Day]\r\n    ORDER BY t1.[SensorID], t1.[Year], t1.[Month], t1.[Day]\r\n\r\n    TRUNCATE TABLE #Holding\r\n       \r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' Application 36'\r\n\r\n    END CATCH\r\n\r\n    /*\r\n      ApplicationID 26 - Liquid Lvel\r\n    */\r\n    BEGIN TRY\r\n\r\n    INSERT INTO #Holding\r\n    (\r\n      [AccountID],\r\n      [SensorID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [data1],\r\n      [Voltage],\r\n      [state],\r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      [AccountID],\r\n      [SensorID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [data] = CONVERT(DECIMAL(8, 2),[Data]),\r\n      [Voltage],\r\n      [state],\r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      [SignalStrength]\r\n    FROM #tempresults t\r\n    INNER JOIN (SELECT RowID FROM #tempresults WHERE ApplicationID = 41) t2 ON t.RowID = t2.RowID AND ISNUMERIC( [Data]) = 1\r\n\r\n\r\n    /*3:46\r\n\r\n      PreAgg - Temperature\r\n\r\n    Get the PreAgg data FROM the segmented Temp table\r\n    */\r\n    INSERT INTO #PreAgg\r\n    (\r\n      [AccountID],\r\n      [SensorID],\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [SplitValue],\r\n      [Min1],\r\n      [Max1],\r\n      [Avg1],\r\n      [Avg_Voltage],\r\n      [SensorMessageCount],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      t1.[AccountID],\r\n      t1.[SensorID],\r\n      t1.[ApplicationName],\r\n      t1.[ApplicationID],\r\n      t1.[CSNetID],\r\n      t1.[Year],\r\n      t1.[Month],\r\n      t1.[Day],\r\n      'PSI',\r\n      [MinTemp] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [MaxTemp] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [AvgTemp] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [Avg_Voltage] = AVG([Voltage]),\r\n      [Counts] = COUNT(*),\r\n      FLOOR(AVG([SignalStrength]))\r\n    FROM #Holding t1\r\n    GROUP BY\r\n      t1.[AccountID],\r\n      t1.[SensorID],\r\n      t1.[ApplicationName],\r\n      t1.[ApplicationID],\r\n      t1.[CSNetID],\r\n      t1.[Year],\r\n      t1.[Month],\r\n      t1.[Day]\r\n    ORDER BY t1.[SensorID], t1.[Year], t1.[Month], t1.[Day]\r\n\r\n    TRUNCATE TABLE #Holding\r\n\r\n       \r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' Application 41'\r\n\r\n    END CATCH\r\n\r\n    /*\r\n      ApplicationID 93\r\n    */\r\n\r\n    BEGIN TRY\r\n\r\n    INSERT INTO #Holding\r\n    (\r\n      [AccountID],\r\n      [SensorID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [data1],\r\n      [Voltage],\r\n      [state],\r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      [AccountID],\r\n      [SensorID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [data] = CONVERT(DECIMAL(18, 2), dbo.SplitIndex([Data], ',', 0)), \r\n      [Voltage], \r\n      [state], \r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      [SignalStrength]\r\n            FROM #tempresults t\r\n    INNER JOIN(SELECT RowID FROM #tempresults WHERE ApplicationID in (93,94,120)) t2 ON t.RowID = t2.RowID AND ISNUMERIC( [Data]) = 1\r\n\r\n\r\n    INSERT INTO #PreAgg\r\n    (\r\n      [AccountID],\r\n      [SensorID],\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [SplitValue],\r\n      [Min1],\r\n      [Max1],\r\n      [Avg1],\r\n      [Avg_Voltage],\r\n      [SensorMessageCount],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      t1.[AccountID],\r\n      t1.[SensorID],\r\n      t1.[ApplicationName],\r\n      t1.[ApplicationID],\r\n      t1.[CSNetID],\r\n      t1.[Year],\r\n      t1.[Month],\r\n      t1.[Day],\r\n      'AmpHours',\r\n      [MinTemp] = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [MaxTemp] = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [AvgTemp] = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [Avg_Voltage] = AVG([Voltage]),\r\n      [Counts] = COUNT(*),\r\n      FLOOR(AVG([SignalStrength]))\r\n    FROM #Holding t1\r\n    GROUP BY\r\n      t1.[AccountID],\r\n      t1.[SensorID],\r\n      t1.[ApplicationName],\r\n      t1.[ApplicationID],\r\n      t1.[CSNetID],\r\n      t1.[Year],\r\n      t1.[Month],\r\n      t1.[Day]\r\n    ORDER BY t1.[SensorID], t1.[Year], t1.[Month], t1.[Day]\r\n\r\n    TRUNCATE TABLE #Holding\r\n       \r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' Application 93,94,120'\r\n\r\n    END CATCH\r\n\r\n    BEGIN TRY \r\n\r\n    /*\r\n      ApplicationID 51 - Seat\r\n    */\r\n    --INSERT INTO #Holding\r\n    --(\r\n    --  [AccountID],\r\n    --  [SensorID],\r\n    --  [CSNetID],\r\n    --  [Month],\r\n    --  [Day],\r\n    --  [data1],\r\n    --  [Voltage],\r\n    --  [state],\r\n    --  [ApplicationID],\r\n    --  [ApplicationName]\r\n    --)\r\n    SELECT\r\n      t.[RowID],\r\n      [AccountID],\r\n      [SensorID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [Data1]    = [data],\r\n      [Voltage],\r\n      [state],\r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      SignalStrength\r\n    INTO #HoldingTest\r\n    FROM #tempresults t\r\n    INNER JOIN (SELECT RowID FROM #tempresults WHERE [ApplicationID] = 107) t2 on t.RowID = t2.RowID\r\n\r\n    SELECT\r\n      [AccountID],\r\n      [SensorID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [data1] = f.item,\r\n      SplitValue = case when Row_Number() OVER (Partition BY [RowID] ORDER BY Data1) = 1 THEN 'Lux' ELSE CASE WHEN Row_Number() OVER(Partition BY [RowID] ORDER BY Data1) = 2  THEN 'LightDetect' ELSE 'State' END END,\r\n\r\n     [Voltage],\r\n\r\n     [state],\r\n\r\n     [ApplicationID],\r\n\r\n     [ApplicationName],\r\n\r\n     [SignalStrength]\r\n    INTO #Holding2\r\n    FROM #HoldingTest\r\n    CROSS APPLY dbo.Split(data1, '|') f\r\n\r\n    insert into  #PreAgg\r\n    (\r\n      [AccountID],\r\n      [SensorID] ,\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day] ,\r\n      [SplitValue],\r\n      [Min1],\r\n      [Max1],\r\n      [Avg1],\r\n      [Avg_Voltage],\r\n      [SensorMessageCount],\r\n      [FalseCount],\r\n      [TrueCount],\r\n      SignalStrength\r\n    )\r\n    SELECT\r\n      AccountID,\r\n      SensorID,\r\n      ApplicationName,\r\n      ApplicationID,\r\n      CSNetID,\r\n      [Year],\r\n      Month,\r\n      Day,\r\n      SplitValue,\r\n      Min1 = Min(CONVERT(DECIMAL(16, 4), [data1])),\r\n      Max1 = Max(CONVERT(DECIMAL(16, 4), [data1])),\r\n      Avg1 = AVG(CONVERT(DECIMAL(16, 4), [data1])),\r\n      AVG(Voltage),\r\n      COUNT = (SELECT Count(*) From #HoldingTest h where h.sensorid = h2.sensorid and h.year = h2.year and h.Month = h2.month and h.day = h2.day),\r\n      NULL,\r\n      NULL,\r\n      FLOOR(Avg(SignalStrength))\r\n    FROM #Holding2 h2\r\n    WHERE SplitValue = 'Lux'\r\n      AND State & 16 != 16\r\n    GROUP BY\r\n      AccountID,\r\n      SensorID,\r\n      ApplicationName,\r\n      ApplicationID,\r\n      CSNetID,\r\n      [Year],\r\n      Month,\r\n      Day,\r\n      SplitValue\r\n\r\n    insert into  #PreAgg\r\n    (\r\n      [AccountID],\r\n      [SensorID] ,\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day] ,\r\n      [SplitValue],\r\n      [Min1],\r\n      [Max1],\r\n      [Avg1],\r\n      [Avg_Voltage],\r\n      [SensorMessageCount],\r\n      [FalseCount],\r\n      [TrueCount],\r\n      SignalStrength\r\n    )\r\n    SELECT\r\n      AccountID,\r\n      SensorID,\r\n      ApplicationName,\r\n      ApplicationID,\r\n      CSNetID,\r\n      [Year],\r\n      Month,\r\n      Day,\r\n      SplitValue,\r\n      Min1 = NULL,\r\n      Max1 = NULL,\r\n      Avg1 = NULL,\r\n      AVG(Voltage),\r\n      COUNT         = (SELECT COUNT(*) From #HoldingTest h where h.sensorid = h2.sensorid AND h.year = h2.year and h.Day = h2.Day and h.Month = h2.Month),\r\n      FalseCount    = (SELECT COUNT(*) FROM #HoldingTest h where h.sensorid = h2.SensorID and h.year = h2.year and h.Data1 LIKE '%False%' AND h.Day = h2.Day and h.Month = h2.Month),\r\n      TrueCount     = (SELECT COUNT(*) FROM #HoldingTest h where h.sensorid = h2.SensorID and h.year = h2.year and h.Data1 LIKE '%True%' AND h.Day = h2.Day and h.Month = h2.Month),\r\n      FLOOR(AVG(SignalStrength))\r\n    FROM #Holding2 h2\r\n    WHERE SplitValue = 'LightDetect'\r\n      AND State & 16 != 16\r\n    GROUP BY\r\n      [AccountID],\r\n      [SensorID],\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [SplitValue]\r\n\r\n    DROP TABLE #HoldingTest\r\n    DROP TABLE #Holding2\r\n\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' Application 107'\r\n\r\n    END CATCH\r\n\r\n    BEGIN TRY\r\n\r\n    SELECT\r\n      t.[RowID],\r\n      [AccountID],\r\n      [SensorID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [Data1]    = [data],\r\n      [Voltage],\r\n      [state],\r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      SignalStrength\r\n    INTO #HoldingTest2\r\n    FROM #tempresults t\r\n    INNER JOIN (SELECT RowID FROM #tempresults WHERE [ApplicationID] = 95) t2 on t.RowID = t2.RowID\r\n\r\n    SELECT\r\n      [AccountID],\r\n      [SensorID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [data1] = f.item,\r\n      SplitValue = case (Row_Number() OVER (Partition BY [RowID] ORDER BY Data1)) \r\n                WHEN 1 THEN 'X-Axis Speed'\r\n                WHEN 2 THEN 'Y-Axis Speed'\r\n                WHEN 3 THEN 'Z-Axis Speed'\r\n                WHEN 4 THEN 'X-Axis Frequency' \r\n                WHEN 5 THEN 'Y-Axis Frequency' \r\n                WHEN 6 THEN 'Z-Axis Frequency'\r\n                WHEN 7 THEN 'DutyCycle' \r\n                ELSE 'State' END,\r\n      [Voltage], \r\n      [state], \r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      SignalStrength\r\n    INTO #Holding3\r\n    FROM #HoldingTest2\r\n    CROSS APPLY dbo.Split(data1, '|') f\r\n\r\n    insert into  #PreAgg\r\n    (\r\n      [AccountID],\r\n      [SensorID] ,\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day] ,\r\n      [SplitValue],\r\n      [Min1],\r\n      [Max1],\r\n      [Avg1],\r\n      [Avg_Voltage],\r\n      [SensorMessageCount],\r\n      [FalseCount],\r\n      [TrueCount],\r\n      SignalStrength\r\n    )\r\n    SELECT\r\n      AccountID,\r\n      SensorID,\r\n      ApplicationName,\r\n      ApplicationID,\r\n      CSNetID,\r\n      [Year],\r\n      Month,\r\n      Day,\r\n      SplitValue,\r\n      Min1 = Min(CONVERT(DECIMAL(16, 4), [data1])),\r\n      Max1 = Max(CONVERT(DECIMAL(16, 4), [data1])),\r\n      Avg1 = AVG(CONVERT(DECIMAL(16, 4), [data1])),\r\n      AVG(Voltage),\r\n      COUNT = (SELECT Count(*) From #HoldingTest2 h where h.sensorid = h2.sensorid and h.year =h2.year and h.Month = h2.month and h.day = h2.day),\r\n      NULL,\r\n      NULL,\r\n      FLOOR(AVG(SignalStrength))\r\n    FROM #Holding3 h2\r\n    WHERE State & 16 != 16\r\n      AND SplitValue != 'State'\r\n    GROUP BY\r\n      [AccountID],\r\n      [SensorID],\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [SplitValue]\r\n\r\n         DROP TABLE #HoldingTest2\r\n    DROP TABLE #Holding3\r\n    TRUNCATE TABLE #Holding\r\n\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' Application 95'\r\n\r\n    END CATCH\r\n\r\n    /*\r\n      ApplicationID 51 - Seat\r\n    */\r\n\r\n    BEGIN TRY\r\n\r\n    INSERT INTO #Holding\r\n    (\r\n      [AccountID],\r\n      [SensorID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [data1],\r\n      [Voltage],\r\n      [state],\r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      [AccountID], \r\n      [SensorID], \r\n      [CSNetID], \r\n      [Year],\r\n      [Month], \r\n      [Day], \r\n      [data] = CASE WHEN SUBSTRING([data], 0, CHARINDEX(',', [data], 0)) = 'False' THEN NULL\r\n                    ELSE SUBSTRING([data], CHARINDEX(',', [data], 0) + 1, LEN([data]))\r\n                    END, \r\n      [Voltage], \r\n      [state], \r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      [SignalStrength]\r\n            FROM #tempresults t\r\n    INNER JOIN(SELECT RowID FROM #tempresults WHERE ApplicationID = 51) t2 ON t.RowID = t2.RowID\r\n\r\n\r\n\r\n    --UPDATE h\r\n    --  SET[Data1] = CASE WHEN SUBSTRING(CONVERT(VARCHAR(10, [Data1]), 0, CHARINDEX(',', [Data1], 0)) = 'False' THEN NULL\r\n    --                     ELSE SUBSTRING([Data1], CHARINDEX(',', [Data1], 0) + 1, LEN([Data1]))\r\n    --                END\r\n    --FROM #Holding h\r\n\r\n\r\n    /*3:46\r\n\r\n      PreAgg - Temperature\r\n\r\n    Get the PreAgg data FROM the segmented Temp table\r\n    */\r\n    insert into  #PreAgg\r\n    (\r\n      [AccountID],\r\n      [SensorID] ,\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day] ,\r\n      [SplitValue],\r\n      [Min1],\r\n      [Max1],\r\n      [Avg1],\r\n      [Avg_Voltage],\r\n      [SensorMessageCount],\r\n      [FalseCount],\r\n      [TrueCount],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      t1.[AccountID],\r\n      t1.[SensorID],\r\n      t1.[ApplicationName],\r\n      t1.[ApplicationID],\r\n      t1.[CSNetID],\r\n      t1.[Year],\r\n      t1.[Month],\r\n      t1.[Day],\r\n      'KOhms',\r\n      [MinTemp]     = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [MaxTemp]     = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [AvgTemp]     = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [Avg_Voltage] = AVG([Voltage]),\r\n      [Counts]      = COUNT(*),\r\n      [FalseCount]  = (SELECT COunt(*) FROM #Holding h WHERE h.SensorID = t1.sensorid AND h.data1 is null),\r\n      [TrueCount] = (SELECT COunt(*) FROM #Holding h WHERE h.SensorID = t1.sensorid AND h.data1 is not null),\r\n      FLOOR(AVG([SignalStrength]))\r\n    FROM #Holding t1\r\n    GROUP BY\r\n      t1.[AccountID],\r\n      t1.[SensorID],\r\n      t1.[ApplicationName],\r\n      t1.[ApplicationID],\r\n      t1.[CSNetID],\r\n      t1.[Year],\r\n      t1.[Month],\r\n      t1.[Day]\r\n    ORDER BY t1.[SensorID], t1.[Year], t1.[Month], t1.[Day]\r\n\r\n    TRUNCATE TABLE #Holding\r\n       \r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' Application 51'\r\n\r\n    END CATCH\r\n\r\n    /*\r\n      ApplicationID 51 - Seat\r\n    */\r\n\r\n    BEGIN TRY\r\n\r\n    INSERT INTO #Holding\r\n    (\r\n      [AccountID],\r\n      [SensorID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [data1],\r\n      [Voltage],\r\n      [state],\r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      [AccountID],\r\n      [SensorID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [data],\r\n      [Voltage],\r\n      [state],\r\n      [ApplicationID],\r\n      [ApplicationName],\r\n      [SignalStrength]\r\n    FROM #tempresults t\r\n    INNER JOIN (SELECT RowID FROM #tempresults WHERE [ApplicationID] = 1) t2 on t.RowID = t2.RowID\r\n\r\n\r\n    /*3:46\r\n\r\n      PreAgg - Temperature\r\n\r\n    Get the PreAgg data FROM the segmented Temp table\r\n    */\r\n    insert into  #PreAgg\r\n    (\r\n      [AccountID],\r\n      [SensorID],\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [SplitValue],\r\n      [Min1],\r\n      [Max1],\r\n      [Avg1],\r\n      [Avg_Voltage],\r\n      [SensorMessageCount],\r\n      [FalseCount],\r\n      [TrueCount],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      t1.[AccountID],\r\n      t1.[SensorID],\r\n      t1.[ApplicationName],\r\n      t1.[ApplicationID],\r\n      t1.[CSNetID],\r\n      t1.[Year],\r\n      t1.[Month],\r\n      t1.[Day],\r\n      'Volts',\r\n      [MinTemp]     = MIN(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [MaxTemp]     = Max(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [AvgTemp]     = AVG(CONVERT(DECIMAL(18, 4), t1.[data1])),\r\n      [Avg_Voltage] = AVG([Voltage]),\r\n      [Counts]      = COUNT(*),\r\n      [FalseCount]  = (SELECT COunt(*) FROM #Holding h WHERE h.[SensorID] = t1.[SensorID] AND h.[data1] is null),\r\n      [TrueCount] = (SELECT COunt(*) FROM #Holding h WHERE h.[SensorID] = t1.[SensorID] AND h.[data1] is not null),\r\n      FLOOR(AVG([SignalStrength]))\r\n    FROM #Holding t1\r\n    GROUP BY\r\n      t1.[AccountID],\r\n      t1.[SensorID],\r\n      t1.[ApplicationName],\r\n      t1.[ApplicationID],\r\n      t1.[CSNetID],\r\n      t1.[Year],\r\n      t1.[Month],\r\n      t1.[Day]\r\n    ORDER BY t1.[SensorID], t1.[Year], t1.[Month], t1.[Day]\r\n\r\n    TRUNCATE TABLE #Holding\r\n       \r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' Applicaiton 1'\r\n\r\n    END CATCH\r\n    /*\r\n\r\n        Monnit Application ID 53 - Multi NERS Temp\r\n        ('temp1, temp2....., temp 8')\r\n\r\n    */\r\n\r\n    BEGIN TRY\r\n\r\n    /*\r\n    Move these into a temp table to split on - if not moved,\r\n    the entire datamessage temp table would be attempted to\r\n    be split in the next step\r\n    */\r\n    SELECT\r\n      h.*\r\n    INTO #spectemp2\r\n    FROM #tempresults h\r\n    INNER JOIN (SELECT RowID FROM #tempresults WHERE ApplicationID = 53) t2 ON h.RowID = t2.RowID\r\n\r\n    /*\r\n      Split on ',' will put each temp[x] into it's own row for pre-agg\r\n    */\r\n    SELECT\r\n      [ProbeNumber] = ROW_NUMBER() OVER (PARTITION BY [RowID] ORDER BY[RowID]),\r\n      *,\r\n      value = f.Item\r\n    INTO #SpecTemp\r\n    FROM #spectemp2 t\r\n    CROSS APPLY dbo.split(t.[data], ',') f\r\n\r\n\r\n    /*:01\r\n\r\n      Scrubs bad data reading but keeps record so minmaxavg is adjusted AND\r\n      counts are still in place\r\n    */\r\n    UPDATE #SpecTemp \r\n    SET[value] = NULL\r\n   WHERE[Value] < -100 OR[Value] > 300\r\n\r\n\r\n\r\n    /*\r\n    :16\r\n\r\n      ApplicationID 60 - Weighted Activity\r\n  \r\n      ('Weight|Standby|Count|Urgent')\r\n\r\n      Put into temp table to allow faster splitting in next step\r\n    */\r\n    --SELECT\r\n    --h.*\r\n    --INTO #WeightedActivity\r\n    --FROM #tempresults h\r\n    --INNER JOIN(SELECT rowid FROM #tempresults where ApplicationID = 60) t2 on h.RowID = t2.RowID\r\n\r\n\r\n    --/*\r\n    --Splits each pipelined value into it's own rows. \r\n    --1 - Weight, 2 - Standby, 3 - DLCount, 4 - Urgent\r\n    --*/\r\n\r\n    --SELECT\r\n    --  [SplitValue] = Row_Number() OVER (PARTITION BY [RowID] ORDER BY[RowID]),\r\n    --  * \r\n    --INTO #WeightedActivity2\r\n    --FROM #WeightedActivity t\r\n    --CROSS APPLY string_split(t.[data], '|') f\r\n\r\n    /*:11\r\n      PreAgg - Multi NERS (ProbeNumber[x])\r\n\r\n    Get the PreAgg data FROM the segmented Temp table\r\n    */\r\n    insert into  #PreAgg\r\n    (\r\n      [AccountID],\r\n      [SensorID] ,\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day] ,\r\n      [SplitValue],\r\n      [Min1],\r\n      [Max1],\r\n      [Avg1],\r\n      [Avg_Voltage],\r\n      [SensorMessageCount],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      [AccountID],\r\n      [SensorID],\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [SplitValue]  = 'ProbeNumber' + CONVERT(VARCHAR(2), [ProbeNumber]),\r\n      [MinTemp]     = MIN(CONVERT(DECIMAL(18,4), [Value])),\r\n      [MaxTemp]     = Max(CONVERT(DECIMAL(18,4), [Value])),\r\n      [AvgTemp]     = AVG(CONVERT(DECIMAL(18,4), [Value])),\r\n      [Avg_Voltage] = AVG(Voltage),\r\n      [Counts]      = COUNT(*),\r\n      FLOOR(AVG([SignalStrength]))\r\n    FROM #spectemp\r\n    GROUP BY\r\n      [AccountID],\r\n      [SensorID],\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [ProbeNumber]\r\n            ORDER BY[SensorID],[Year], [Month], [Day], [ProbeNumber]\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' Application 53'\r\n\r\n    END CATCH\r\n\r\n    /*:24 \r\n\r\n      Get aware states FROM the DataMessages for post insert updates of Aware States\r\n      this is used as a means to allow the Initial Inserts to get the count of all DMs\r\n      AND then the post insert update to be the count of the aware states.\r\n    */\r\n    BEGIN TRY\r\n\r\n    INSERT INTO #AwareStates\r\n    (\r\n      [SensorID],\r\n      [Day],\r\n      [Month],\r\n      [Year],\r\n      [AwareStateCounts]\r\n    )\r\n    SELECT\r\n      [SensorID], \r\n      [Day], \r\n      [Month], \r\n      [Year],\r\n      [AwareStateCounts] = COUNT(*)\r\n    FROM #tempresults t2 \r\n    INNER JOIN Account a WITH(NOLOCK) ON t2.AccountID = a.accountid\r\n   WHERE t2.[State] & 2 = 2 \r\n\r\n   GROUP BY t2.[Day], t2.[Year], t2.[Month], t2.[SensorID]\r\n\r\n\r\n   END TRY\r\n   BEGIN CATCH\r\n\r\n     set @ErrorMessage = @ErrorMessage + ' Aware State Error'\r\n\r\n\r\n   END CATCH\r\n\r\n\r\n\r\n    /*:11\r\n\r\n      PreAgg -Weighted Activity (Standby)\r\n\r\n      Summing up the Standy Counts\r\n    */\r\n    --insert into  #PreAgg\r\n    --(\r\n    --  [AccountID],\r\n    --  [SensorID] ,\r\n    --  [ApplicationName],\r\n    --  [ApplicationID],\r\n    --  [CSNetID],\r\n    --  [Month],\r\n    --  [Day] ,\r\n    --  [SplitValue],\r\n    --  [FalseCount],\r\n    --  [Avg_Voltage]\r\n    --)\r\n    --SELECT\r\n    --  [AccountID],\r\n    --  [SensorID],\r\n    --  [ApplicationName],\r\n    --  [ApplicationID],\r\n    --  [CSNetID],\r\n    --  [Month],\r\n    --  [Day],\r\n    --  [SplitValue] = 'Standby',\r\n    --  COUNT(*),\r\n    --  [Avg_Voltage] = AVG(Voltage)\r\n    --FROM #WeightedActivity2\r\n    --WHERE[SplitValue] in (1)\r\n    --  AND SUBSTRING([Data], charindex('|', [Data], 0) + 1 , charindex('|', [Data], charindex('|', [Data], 0) + 1 ) -1 - charindex('|', [Data], 0)) = 'True'\r\n    --GROUP BY \r\n    --  [AccountID],\r\n    --  [SensorID],\r\n    --  [ApplicationName],\r\n    --  [ApplicationID],\r\n    --  [CSNetID],\r\n    --  [Month],\r\n    --  [Day],\r\n    --  [SplitValue]\r\n    --ORDER BY SensorID, Month, Day, [SplitValue]\r\n\r\n\r\n    --/*:11\r\n\r\n    --  PreAgg -Weighted Activity (Standby)\r\n\r\n    --  Summing up the DLCounts - note: dlcounts are not added when in Standby\r\n    --*/\r\n    --insert into  #PreAgg\r\n    --(\r\n    --  [AccountID],\r\n    --  [SensorID] ,\r\n    --  [ApplicationName],\r\n    --  [ApplicationID],\r\n    --  [CSNetID],\r\n    --  [Month],\r\n    --  [Day] ,\r\n    --  [SplitValue],\r\n    --  [FalseCount],\r\n    --  [Avg_Voltage]\r\n    --)\r\n    --SELECT\r\n    --  [AccountID],\r\n    --  [SensorID],\r\n    --  [ApplicationName],\r\n    --  [ApplicationID],\r\n    --  [CSNetID],\r\n    --  [Month],\r\n    --  [Day],\r\n    --  [SplitValue]    = 'DLCount',\r\n    --  [StandbyCounts] = SUM(Convert(INT, [Value])),\r\n    --  [Avg_Voltage]   = AVG([Voltage])\r\n    --FROM #WeightedActivity2\r\n    --WHERE[SplitValue] in (3)\r\n    --  AND SUBSTRING([Data], charindex('|', [Data], 0) + 1 , charindex('|', [Data], charindex('|', [Data], 0) + 1 ) -1 - charindex('|', [Data], 0)) = 'False'\r\n    --GROUP BY \r\n    --[AccountID],\r\n    --[SensorID],\r\n    --[ApplicationName],\r\n    --[ApplicationID],\r\n    --[CSNetID],\r\n    --[Month],\r\n    --[Day],\r\n    --[SplitValue]\r\n    --ORDER BY[SensorID], [Month], [Day], [SplitValue]\r\n\r\n    --/*:11\r\n\r\n    --  PreAgg -Weighted Activity (Standby)\r\n\r\n    --  MinMaxAvg of Weight - note: Weight are not calculated when in Standby\r\n    --*/\r\n    --insert into  #PreAgg\r\n    --(\r\n    --  [AccountID],\r\n    --  [SensorID] ,\r\n    --  [ApplicationName],\r\n    --  [ApplicationID],\r\n    --  [CSNetID],\r\n    --  [Month],\r\n    --  [Day] ,\r\n    --  [SplitValue],\r\n    --  [Min1],\r\n    --  [Max1],\r\n    --  [Avg1],\r\n    --  [Avg_Voltage]\r\n    --)\r\n    --SELECT\r\n    --  [AccountID],\r\n    --  [SensorID],\r\n    --  [ApplicationName],\r\n    --  [ApplicationID],\r\n    --  [CSNetID],\r\n    --  [Month],\r\n    --  [Day],\r\n    --  [SplitValue] = 'Weight',\r\n    --  MIN(CONVERT(DECIMAL(8,3), [Value])),\r\n    --  Max(CONVERT(DECIMAL(8,3), [Value])),\r\n    --  AVG(CONVERT(DECIMAL(8,3), [Value])),\r\n    --  [Avg_Voltage] = AVG(Voltage)\r\n    --FROM #WeightedActivity2\r\n    --WHERE[SplitValue] in (1)\r\n    --AND SUBSTRING([Data], charindex('|', [Data], 0) + 1 , charindex('|', [Data], charindex('|', [Data], 0) + 1 ) -1 - charindex('|', [Data], 0)) = 'False'\r\n    --GROUP BY \r\n    --  [AccountID],\r\n    --  [SensorID],\r\n    --  [ApplicationName],\r\n    --  [ApplicationID],\r\n    --  [CSNetID],\r\n    --  [Month],\r\n    --  [Day],\r\n    --  [SplitValue]\r\n    --ORDER BY[SensorID], [Month], [Day], [SplitValue]\r\n\r\n    --/*\r\n    --  Updated the Weighted Activity Counts with the total\r\n    --  sensor message counts, including standby, as well as the\r\n    --  average Voltage\r\n    --*/\r\n    --UPDATE p\r\n    --    set p.[Avg_Voltage]        = d.[avg_voltage],\r\n    --        p.[SensorMessageCount] = d.[counts]\r\n    --FROM #PreAgg p\r\n    --INNER JOIN (SELECT\r\n    --              [AccountID],\r\n    --              [SensorID],\r\n    --              [Month],\r\n    --              [Day],\r\n    --              [avg_voltage] = avg([voltage]), \r\n    --              [counts]      = count(*)\r\n    --            FROM #WeightedActivity \r\n    --            GROUP BY[AccountID], [SensorID], [Month], [Day]\r\n    --            ) d on p.[AccountID] = d.[AccountID] AND p.[SensorID] = d.[SensorID] AND p.[Month] = d.[Month] AND p.[Day] = d.[Day]\r\n\r\n\r\n\r\n    /*:25\r\n\r\n    1    Analog Voltage\r\n    19  Activity_p2\r\n    21  Lux\r\n    32  500V Meter\r\n    41  Pressure\r\n    59  Battery Health\r\n    70  Resistance\r\n    72  0-5V Measure\r\n    73  Filtered Pulse Counter\r\n    74  0-10V Measure\r\n    90  Filtered Pulse Counter 64 bit\r\n\r\n    */\r\n    begin try\r\n\r\n    update #tempresults set data = dbo.SplitIndex(data, '|', 0) where ApplicationID = 70 and data like '%|%'\r\n\r\n    insert into  #PreAgg\r\n    (\r\n      [AccountID],\r\n      [SensorID] ,\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day] ,\r\n      [Min1],\r\n      [Max1],\r\n      [Avg1],\r\n      [Avg_Voltage],\r\n      [SensorMessageCount],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      [AccountID],\r\n      [SensorID],\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day],\r\n      [Min] = MIN(CONVERT(DECIMAL(18,4), [Data])),\r\n      [Max] = Max(CONVERT(DECIMAL(18,4), [Data])),\r\n      [Avg] = AVG(CONVERT(DECIMAL(18,4), [Data])),\r\n      [Avg_BatteryVoltage] = AVG(Voltage),\r\n      [Counts] = COUNT(*),\r\n      FLOOR(AVG([SignalStrength]))\r\n    FROM #tempresults \r\n    WHERE[ApplicationID] IN(22, 32,72,74, 19,21,41,59,70, 73, 90, 79, 82,83)\r\n    GROUP BY\r\n      [AccountID],\r\n      [SensorID],\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day]\r\n    ORDER BY[SensorID], [Year],[Month], [Day]\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' Application 22, 32,72,74, 19,21,41,59,70, 73, 90, 79, 82'\r\n\r\n    END CATCH\r\n\r\n    /*:19\r\n    'Dry Contact', \r\n    'Water', \r\n    'Activity_p1', \r\n    'Magnetic Presence',\r\n    'Open / Closed', \r\n    'Button', \r\n    'PIR',\r\n    'Light Presence', \r\n    '120VAC Detection', \r\n    '240V Detection', \r\n    'AC Voltage Detection', \r\n    'DC Voltage Detection',\r\n    'Basic Control', \r\n    'Water Area Sensor', \r\n    'PIR - Alta'\r\n    */\r\n    BEGIN TRY\r\n\r\n\r\n    INSERT INTO  #PreAgg\r\n    (\r\n      [AccountID],\r\n      [SensorID] ,\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day] ,\r\n      [Avg_Voltage],\r\n      [SensorMessageCount],\r\n      [SignalStrength]\r\n    )\r\n    SELECT\r\n      [AccountID],\r\n      [SensorID] ,\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day] ,\r\n      [Avg_Voltage] = AVG(Voltage),\r\n      [SensorMessageCount] = COUNT(*),\r\n      FLOOR(AVG([SignalStrength]))\r\n    FROM #tempresults \r\n    WHERE[ApplicationID] IN(3,4,5,6,9,11,23,27,31,52,54,64,71,76,78,101,119,123)\r\n    GROUP BY\r\n      [AccountID],\r\n      [SensorID],\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day]\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' Application 3,4,5,6,9,11,23,27,31,52,54,64,71,76,78,101,119,123'\r\n\r\n    END CATCH\r\n\r\n    BEGIN TRY\r\n\r\n      /*:06*/\r\n    SELECT\r\n      p.[AccountID],\r\n      p.[SensorID],\r\n      p.[CSNetID],\r\n      p.[Year],\r\n      p.[Month],\r\n      p.[Day],\r\n      [Counts] = ISNULL(COUNT(*), 0)\r\n    INTO #Counts\r\n    FROM #PreAgg p\r\n    LEFT JOIN #tempresults t on p.SensorID = t.sensorid AND p.Year = t.YEar and p.Month = t.Month AND p.Day = t.Day AND p.CSNetID = t.CSNetID AND p.AccountID = t.AccountID\r\n    WHERE p.[ApplicationID] IN (3,4,5,6,9,11,23,27,31,52,54,64,71, 76,78,101,119,123 )\r\n      AND t.data = 'True'\r\n    GROUP BY\r\n    p.[AccountID],\r\n    p.[SensorID],\r\n    p.[CSNetID],\r\n    p.[Year],\r\n    p.[Month],\r\n    p.[Day]\r\n\r\n\r\n    --/*:02*/\r\n    --update p\r\n    -- set p.[Min1] = 0,\r\n    --    p.[Max1] = p.SensorMessageCount\r\n    --FROM #PreAgg p\r\n    --where p.[ApplicationID] IN (\r\n    --                                    3,4,5,6,\r\n    --                                    9,11,23,27,\r\n    --                                    31,54,64,71,\r\n    --                                    76,78,101\r\n    --                                  )\r\n\r\n\r\n    /*:01\r\n\r\n      Logic for updating the true/false counts of Boolean sensor profiles\r\n    */\r\n    UPDATE p\r\n     SET p.[TrueCount]  = ISNULL(t.[Counts], 0),\r\n         p.[FalseCount] = p.[SensorMessageCount] - ISNULL(t.[Counts], 0)\r\n    FROM #PreAgg p\r\n    LEFT JOIN #Counts t ON p.[SensorID] = t.[SensorID] AND p.[Year] = t.[Year] and p.[Month] = t.[Month] AND p.[Day] = t.[Day] AND p.[AccountID] = t.[AccountID] AND p.[CSNetID] = t.[CSNetID]\r\n    WHERE p.[ApplicationID] IN (3,4,5,6, 9,11,23,27,31,52,54,64,71, 76,78,101,119,123)\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' Application 3,4,5,6,9,11,23,27,31,52,54,64,71, 76,78,101 ,119,123'\r\n\r\n    END CATCH\r\n\r\n    BEGIN TRY\r\n\r\n    INSERT INTO  #PreAgg\r\n    (\r\n      [AccountID],\r\n      [SensorID] ,\r\n      [ApplicationName],\r\n      [ApplicationID],\r\n      [CSNetID],\r\n      [Year],\r\n      [Month],\r\n      [Day] ,\r\n      [Avg_Voltage],\r\n      [SensorMessageCount],\r\n      [SignalStrength]\r\n    )\r\n    select\r\n      accountid,\r\n      sensorid,\r\n      ApplicationName,\r\n      ApplicationID,\r\n      csnetid,\r\n      [Year],\r\n      month,\r\n      day,\r\n      AvgVoltage = avg(voltage),\r\n      MessageCounts = count(*),\r\n      FLOOR(AVG([SignalStrength]))\r\n    from #tempresults \r\n    where ApplicationID not in (select DISTINCT ApplicationID from #PreAgg)\r\n    group by\r\n      accountid,\r\n      sensorid,\r\n      ApplicationName,\r\n      ApplicationID,\r\n      csnetid,\r\n      [Year],\r\n      month,\r\n      day\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' All other Applications'\r\n\r\n    END CATCH\r\n\r\n    /*:03\r\n\r\n      Update aware state counts for all sensors\r\n    */\r\n    BEGIN TRY\r\n\r\n    UPDATE p\r\n      SET[awarestatecounts] = ISNULL(a2.[AwareStateCounts],0)\r\n    FROM #PreAgg p\r\n    LEFT JOIN #AwareStates a2 ON p.[SensorID] = a2.[SensorID] and p.[Year] = a2.[Year] AND p.[Day] = a2.[Day] AND p.[Month] = a2.[Month]\r\n    \r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' Aware States Update'\r\n\r\n    END CATCH\r\n\r\n    BEGIN TRY\r\n\r\n     SELECT\r\n      [Date]        =  @LocalStartDate,\r\n      pa.[SensorID],\r\n      PaSensorGuid = NULL,\r\n      pa.[AccountID],\r\n      pa.[ApplicationName],\r\n      pa.[ApplicationID],\r\n      pa.[CSNetID],\r\n      pa.[SplitValue],\r\n      [Min]        = CONVERT(DECIMAL(16,4), pa.Min1),\r\n      [Max]        = CONVERT(DECIMAL(16,4), pa.Max1),\r\n      [Avg]        = CONVERT(DECIMAL(16,4), pa.Avg1),\r\n      pa.[FalseCount],\r\n      pa.[TrueCount],\r\n      pa.[Avg_Voltage],\r\n      SensorMessageCounts = pa.[SensorMessageCount],\r\n      pa.[AwareStateCounts],\r\n      CREATEDATE = GETUTCDATE(),\r\n      Avg_SignalStrength = [SignalStrength]\r\n            INTO #Final\r\n    FROM #PreAgg pa\r\n\r\n\r\n    END TRY\r\n    BEGIN CATCH\r\n\r\n      set @ErrorMessage = @ErrorMessage + ' Final Temp table'\r\n\r\n    END CATCH\r\n\r\n    select* from #final\r\n    order by Date\r\n\r\n      drop table #AwareStates\r\n      drop table #DM\r\n      drop table #Group\r\n      drop table #Holding\r\n      drop table #Offsets\r\n      drop table #PreAgg\r\n      drop table #Results\r\n      drop table #sensorlist\r\n      drop table #tempresults\r\n      drop table #final\r\n      drop table #Counts\r\n      drop table #numerictester3\r\n      drop table #SpecTemp\r\n      drop table #spectemp2\r\n")]
  internal class PreAggChartByDate : BaseDBMethod
  {
    [DBMethodParam("SensorID", typeof (long))]
    public long SensorID { get; private set; }

    [DBMethodParam("UTCStartDate", typeof (DateTime))]
    public DateTime UtcStartDate { get; private set; }

    [DBMethodParam("LocalStartDate", typeof (DateTime))]
    public DateTime LocalDate { get; private set; }

    public List<Monnit.PreAggregatedData> Result { get; private set; }

    public PreAggChartByDate(long sensorID, DateTime utcStartDate, DateTime localDate)
    {
      this.SensorID = sensorID;
      this.UtcStartDate = utcStartDate;
      this.LocalDate = localDate;
      this.Result = BaseDBObject.Load<Monnit.PreAggregatedData>(this.ToDataTable());
    }

    public static List<Monnit.PreAggregatedData> Exec(
      long sensorID,
      DateTime utcStartDate,
      DateTime localDate)
    {
      return new PreAggregatedData.PreAggChartByDate(sensorID, utcStartDate, localDate).Result;
    }
  }
}
